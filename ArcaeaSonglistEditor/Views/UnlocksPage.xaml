<Page x:Class="ArcaeaSonglistEditor.Views.UnlocksPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
      xmlns:viewModels="clr-namespace:ArcaeaSonglistEditor.ViewModels"
      xmlns:models="clr-namespace:ArcaeaSonglistEditor.Core.Models;assembly=ArcaeaSonglistEditor.Core"
      Title="解锁条件"
      Width="Auto"
      Height="Auto">


    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- 工具栏 -->
        <StackPanel Grid.Row="0" Margin="0,0,0,12">
            <WrapPanel ItemHeight="32">
                <TextBox Width="240"
                         Margin="0,0,8,8"
                         Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" />
                <Button Content="搜索"
                        Margin="0,0,8,8"
                        Command="{Binding SearchCommand}" />
            </WrapPanel>

            <WrapPanel ItemHeight="32">
                <Button Content="添加解锁条件" Margin="0,0,8,8" Command="{Binding AddUnlockCommand}" />
                <Button Content="编辑解锁条件" Margin="0,0,8,8" Command="{Binding EditUnlockCommand}" />
                <Button Content="删除解锁条件" Margin="0,0,8,8" Command="{Binding DeleteUnlockCommand}" />
                <Button Content="清空所有" Margin="0,0,8,8" Command="{Binding ClearAllUnlocksCommand}" />
                <Button Content="导入" Margin="0,0,8,8" Command="{Binding ImportUnlocksCommand}" />
                <Button Content="导出" Margin="0,0,8,8" Command="{Binding ExportUnlocksCommand}" />
            </WrapPanel>
        </StackPanel>

        <!-- 主从布局：左侧列表 / 右侧详情 -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*" MinWidth="380" />
                <ColumnDefinition Width="6" />
                <ColumnDefinition Width="*" MinWidth="420" />
            </Grid.ColumnDefinitions>

            <!-- 左：解锁条件列表 -->
            <DataGrid Grid.Column="0"
                      AutoGenerateColumns="False"
                      ItemsSource="{Binding Unlocks}"
                      SelectedItem="{Binding SelectedUnlock}"
                      IsReadOnly="True"
                      SelectionMode="Single"
                      CanUserAddRows="False"
                      CanUserDeleteRows="False"
                      CanUserReorderColumns="False"
                      CanUserResizeRows="False"
                      CanUserSortColumns="True">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="歌曲ID" Binding="{Binding SongId}" Width="180" />
                    <DataGridTextColumn Header="难度" Binding="{Binding RatingClass}" Width="90" />
                    <DataGridTextColumn Header="条件数" Binding="{Binding Conditions.Count}" Width="80" />
                    <DataGridTextColumn Header="条件描述" Binding="{Binding GetDescription}" Width="*" />
                </DataGrid.Columns>
            </DataGrid>

            <GridSplitter Grid.Column="1"
                         Width="6"
                         Background="{StaticResource BrushBorder}"
                         HorizontalAlignment="Stretch"
                         ShowsPreview="True" />

            <!-- 右：详情编辑 -->
            <Border Grid.Column="2"
                    Background="{StaticResource BrushSurface2}"
                    BorderBrush="{StaticResource BrushBorder}"
                    BorderThickness="1"
                    CornerRadius="{StaticResource RadiusSm}"
                    Padding="12">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0"
                               Text="解锁条件详情"
                               FontWeight="SemiBold"
                               Margin="2,0,0,10" />

                    <ScrollViewer Grid.Row="1"
                                  VerticalScrollBarVisibility="Auto"
                                  HorizontalScrollBarVisibility="Auto">
                        <StackPanel IsEnabled="{Binding HasSelectedUnlock}"
                                    MinWidth="720">
                            <GroupBox Header="基础信息">
                                <Grid Margin="4">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="140" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="歌曲ID（songId）" VerticalAlignment="Center" />
                                    <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding SelectedUnlock.SongId, UpdateSourceTrigger=PropertyChanged}" />

                                    <TextBlock Grid.Row="1" Grid.Column="0" Text="难度（ratingClass）" VerticalAlignment="Center" />
                                    <ComboBox Grid.Row="1" Grid.Column="1"
                                              SelectedValue="{Binding SelectedUnlock.RatingClass}"
                                              SelectedValuePath="Tag">
                                        <ComboBoxItem Content="Past" Tag="{x:Static models:ArcaeaRatingClass.Past}" />
                                        <ComboBoxItem Content="Present" Tag="{x:Static models:ArcaeaRatingClass.Present}" />
                                        <ComboBoxItem Content="Future" Tag="{x:Static models:ArcaeaRatingClass.Future}" />
                                        <ComboBoxItem Content="Beyond" Tag="{x:Static models:ArcaeaRatingClass.Beyond}" />
                                        <ComboBoxItem Content="Eternal" Tag="{x:Static models:ArcaeaRatingClass.Eternal}" />
                                    </ComboBox>
                                </Grid>
                            </GroupBox>

                            <GroupBox Header="条件（conditions）">
                                <StackPanel>
                                    <TextBlock Text="建议：直接编辑 JSON，可覆盖所有类型（含选择条件 type=4 的嵌套）。"
                                               Foreground="{StaticResource BrushTextSecondary}"
                                               Margin="0,0,0,8" />

                                    <WrapPanel Margin="0,0,0,8">
                                        <Button Content="刷新 JSON" Command="{Binding RefreshConditionsJsonCommand}" Margin="0,0,8,0" />
                                        <Button Content="应用 JSON" Command="{Binding ApplyConditionsJsonCommand}" Style="{StaticResource PrimaryButton}" />
                                    </WrapPanel>

                                    <TextBox Text="{Binding ConditionsJson, UpdateSourceTrigger=PropertyChanged}"
                                             FontFamily="Consolas"
                                             AcceptsReturn="True"
                                             VerticalScrollBarVisibility="Auto"
                                             HorizontalScrollBarVisibility="Auto"
                                             MinHeight="220" />
                                </StackPanel>
                            </GroupBox>
                        </StackPanel>
                    </ScrollViewer>

                    <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,10,0,0">
                        <Button Content="保存更改"
                                Style="{StaticResource PrimaryButton}"
                                Command="{Binding EditUnlockCommand}" />
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</Page>
